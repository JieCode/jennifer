<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
	<title>弗兰德斯</title>
	<link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
	<div class="flds">
		<div id="fldsPart" class="hide">
			<div class="col-sm-12">
				<h4 style="font-weight:bold;"><span class="yet" style="margin-bottom: 0; background: #4FCB4B;padding-left:0px;"></span><span style="font-size: 16px;color: #333333;letter-spacing: 0;line-height: 16px;">弗兰德斯课堂互动分析系统</span></h4>
				<hr style="height: 1px; background-color: #333;"/>
				<div class="col-sm-12 text-center" style="margin-top: 30px; margin-bottom: 10px;font-size: 16px;">结果反馈</div>
				<div class="col-sm-3"></div>
				<div class="col-sm-6">
					<table class="table table-bordered">
						<thead>
							<tr style="background-color: #ffe6d9">
								<th colspan="2" class="text-center">课堂结构</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td  class="col-sm-9 text-center">教师语言比率</td>
								<td id="teacherWord" class="col-sm-3 text-center"></td>
							</tr>
							<tr>
								<td  class="col-sm-9 text-center">学生语言比率</td>
								<td id="studentWord" class="text-center"></td>
							</tr>
							<tr>
								<td  class="col-sm-9 text-center">课堂沉寂比率</td>
								<td id="slienceWord" class="text-center"> </td>
							</tr>
						</tbody>
						<thead>
							<tr style="background-color: #ffe6d9">
								<th colspan="2" class="text-center">教师倾向</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td  class="col-sm-9 text-center">教师间接影响/教师语言</td>
								<td id="directImpact" class="col-sm-3 text-center"></td>
							</tr>
							<tr>
								<td  class="col-sm-9 text-center">教师直接影响/教师语言</td>
								<td id="indirectEffects" class="text-center"></td>
							</tr>	
						</tbody>
						<thead>
							<tr style="background-color: #ffe6d9">
								<th colspan="2" class="text-center">其他</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td  class="col-sm-9 text-center">学生主动发起语言/学生语言</td>
								<td id="coordinate1" class="col-sm-3 text-center"></td>
							</tr>
							<tr>
								<td  class="col-sm-9 text-center">学生连续语言/学生语言</td>
								<td id="coordinate2" class="text-center"></td>
							</tr>	
							<tr>
								<td  class="col-sm-9 text-center">连续内容讲解/教师语言</td>
								<td id="coordinate3" class="text-center"></td>
							</tr>	
						</tbody>
					</table>
				</div>
				<div class="col-sm-3"></div>
				<div class="col-sm-12" style="margin-bottom: 30px;">
					<span id="fldsSuggest">
					</span>
				</div>
			</div>
			<div class="col-sm-12" style="margin-top: 30px; ">
				<div class="col-sm-12 text-center" style="margin-top: 20px; margin-bottom: 10px;">课堂互动分析矩阵</div>
				<table class="table table-bordered">
					<thead>
						<tr>
							<th colspan="2" style="border: 0px solid #ddd;"></th>
							<th class="text-center" colspan="7">教师</th>
							<th class="text-center" colspan="3">学生</th>
							<th class="text-center" colspan="3">沉寂</th>
							<th></th>
						</tr>
					</thead>
					<tbody id="fldsTable" class="text-center">
						<tr >
							<td colspan="2" style="border-top: 0px solid #ddd;"></td>
							<td>(1)</td>
							<td>(2)</td>
							<td>(3)</td>
							<td>(4)</td>
							<td>(5)</td>
							<td>(6)</td>
							<td>(7)</td>
							<td>(8)</td>
							<td>(9)</td>
							<td>(10)</td>
							<td>(11)</td>
							<td>(12)</td>
							<td>(13)</td>
							<td>总计</td>
						</tr>
						<tr>
							<td rowspan="7" style="padding-top:115px;font-weight: 700">教<br/>师</td>
							<td>(1)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(2)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(3)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(4)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(5)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(6)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(7)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td rowspan="3" style="padding-top:35px;font-weight: 700">学<br/>生</td>
							<td>(8)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(9)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(10)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td rowspan="3" style="padding-top:35px;font-weight: 700">沉<br/>寂</td>
							<td>(11)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(12)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td>(13)</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td>0</td>
							<td></td>
						</tr>
						<tr>
							<td></td>
							<td>总计</td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
							<td></td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
	<script type="text/javascript" src="js/mustache.min.js"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/echarts.min.js"></script>
	<script type="text/javascript" src="js/bootstrap.min.js"></script>
	<script type="text/javascript">
		var debug = 0;
		$(function() {
			$('[data-toggle="popover"]').popover();
			debug && render($('#data').text());
		});
		function durationToString(duration) {
			var min = Math.floor(duration / 60), sec = duration % 60;
			return min + "'" + sec + '"';
		}
		
		function jsonEscape(str) {
			//if (debug)
				return str;
			//else
			//	return str.replace(/\n/g, '\\n').replace(/\r/g, '\\r').replace(/\t/g, '\\t');
		}
	
		function replaceLineBreak(str) {
			return str && str.replace(/\n/g, '<br/>');
		}
// 		var template = $('le-st').html();
// 		Mustache.parse(template);
// 		$('.le-st').empty().removeClass('hide').show();
		var fldstotalsum = 0;
		function render(data) {
			if (console.log) console.log("data: " + data);
// 			try {
				if (typeof data === 'string') data = $.parseJSON(jsonEscape(data));
				(function(fldsData) {
					//fldsData.push([1,2,2,2,2,2,3,1,1,1],[2,2,2,2,2,2,2,3,8,9,9,4,6,7,1,2,5,10,10,10,11,11,11,2,1,1,1,1]);
				    //fldsData.push([6,7,1,3,4,10,5,9,6,4,9,2,13,13,13,13,13,13,1,1,1,1]);
					$.each(fldsData, function(index, item) {
						$.each(item, function(fldsIndex, fldsItem) {
							fldstotalsum += fldsItem;
						})
					}) 
					if (fldstotalsum != 0 && !isNaN(fldstotalsum)) {
						$('#fldsPart').removeClass('hide');			
						//处理弗兰德斯数据
						var fldsMap = {};
						$.each(fldsData, function(index, item) {
							var fldsList = [];
							$.each(item, function(fldsIndex, fldsItem) {
								//装载每次的坐标，避免重复
								if (fldsIndex != item.length - 1) {
									//坐标
									var coordinate = fldsItem + ',' + item[fldsIndex + 1];
									//判断是够有这个map 没有就建一个
									if(typeof(fldsMap[coordinate])==="undefined"){
										fldsMap[coordinate] = '1,1';
										fldsList.push(coordinate);
									} else {
										var fldesValue = fldsMap[coordinate].split(',');
										//判断此次循环时候已经有此坐标
										var fldsFlag = true;
										$.each(fldsList, function(listIndex, listItem) {
											if (listItem == coordinate) {
												fldsFlag = false
											}
										})
										if (fldsFlag) {
											fldsMap[coordinate] = (parseInt(fldesValue[0]) + 1) + ',' + (parseInt(fldesValue[1]) + 1);
											fldsList.push(coordinate);
										} else {
											fldsMap[coordinate] = (parseInt(fldesValue[0]) + 1) + ',' + fldesValue[1];
										}
									}
									
								}
							})
						})
						//$('#fldsTable').children().eq(14).children().eq(3).html();
						for(var key in fldsMap){
							var cyu = key.split(",");
							var fldesValue = fldsMap[key].split(',');
							var s = parseInt(cyu[0]);
							if (s == 8 || s == 1 || s == 11) {
								s = parseInt(cyu[1]) + 1;
							} else {
								s = parseInt(cyu[1]);
							}
							$('#fldsTable').children().eq(cyu[0]).children().eq(s).html((fldesValue[0]/fldesValue[1]).toFixed(0));
						}
						
						var teacherWord = 0; //1~7列次数
						var studentWord = 0; //8~10列次数
						var slienceWord = 0; //11~13沉寂次数
						var allTimes = 0; //总次数
						var directImpact = 0; //1~4列次数
						var indirectEffects = 0; //5~7列次数
						var coordinate1 = 0; //9~10列次数
						var coordinate2 = 0; //(9,9)+(10,10)次数
						var coordinate3 = 0; //(5,5)次数
						var eighthData = 0; //第八列的数量
						
						for (var i = 0; i < 13; i++) {
							var fldsSum = 0;
							var platoon = 0;
							for (var j = 0; j < 13; j++) {
								//列总计
								var value = 0;
								if (j == 0 || j == 7 || j == 10) {
									value = parseInt($('#fldsTable').children().eq(j + 1).children().eq(i + 2).html());
								} else {
									value = parseInt($('#fldsTable').children().eq(j + 1).children().eq(i + 1).html());
								}
								if (i == 4 && j == 4) {
									coordinate3 = value;
								}
								if ((i == 8 && j == 8) || (i == 9 && j == 9)) {
									coordinate2 += value;
								}
								fldsSum += value;
								//排总计
								var value = 0;
								if (i == 0 || i == 7 || i == 10) {
									value = parseInt($('#fldsTable').children().eq(i + 1).children().eq(j + 2).html());
								} else {
									value = parseInt($('#fldsTable').children().eq(i + 1).children().eq(j + 1).html());
								}
								platoon += value;
							}
							if (i < 7) {
								teacherWord += fldsSum;
							}
							if (i >= 7 && i <= 9) {
								studentWord += fldsSum;
							}
							if (i >= 10 && i <= 12) {
								slienceWord += fldsSum;
							}
							if (i < 4) {
								directImpact += fldsSum;
							}
							if (i >= 4 && i <= 6) {
								indirectEffects += fldsSum;
							}
							if (i == 8 || i == 9) {
								coordinate1 += fldsSum;
							}
							if (i == 7) {
								eighthData += fldsSum;
							}
							allTimes += fldsSum;
							$('#fldsTable').children().eq(14).children().eq(i + 2).html(fldsSum);
							$('#fldsTable').children().eq(i + 1).children().last().html(platoon);
						}
						//总计
						$('#fldsTable').children().eq(14).children().last().html(allTimes);
						if (allTimes == 0) {
							allTimes = 1;
							//$('#fldsSuggest').html('分析结论与改进建议：<br/>暂无数据');
						} else {
							var fldsSuggest = '分析结论与改进建议：<br/>'+
							'您这节课的课堂结构方面：教师语言比率为'+ (teacherWord*100/allTimes).toFixed(1) +'%和学生语言比率为'+ (studentWord*100/allTimes).toFixed(1) +'%，课堂沉寂比率为'+ (100 - (teacherWord*100/allTimes).toFixed(1) - (studentWord*100/allTimes).toFixed(1)).toFixed(1) +'%;<br/>'+
						    '教师的影响方面：教师间接影响的比率为'+ (directImpact*100/teacherWord).toFixed(1) +'%，教师直接影响的比率为'+ (indirectEffects*100/teacherWord).toFixed(1) +'%，间接影响行为与直接影响行为分配';
							if (indirectEffects*100/teacherWord >= directImpact*100/teacherWord) {
								fldsSuggest += '不合理';
							} else {
								fldsSuggest += '合理';
							}
							fldsSuggest += '。<br/>学生的学习主动性方面：学生主动发起语言的比占有率为'+ (coordinate1*100/studentWord).toFixed(1) +'%，';
							if (eighthData > (studentWord - eighthData)) {
								fldsSuggest += '被动的，建议教师鼓励学生表达自己的观点，勇于提出问题。';
							} else {
								fldsSuggest += '主动的，您较注重培养学生质疑能力，特别棒。';
							}
							$('#fldsSuggest').html(fldsSuggest);
						}
						
						$('#teacherWord').html((teacherWord*100/allTimes).toFixed(1) + '%');
						$('#studentWord').html((studentWord*100/allTimes).toFixed(1) + '%');
						$('#slienceWord').html((100 - (teacherWord*100/allTimes).toFixed(1) - (studentWord*100/allTimes).toFixed(1)).toFixed(1) + '%');
						$('#directImpact').html((directImpact*100/(teacherWord == 0 ? 1 : teacherWord)).toFixed(1) + '%');
						$('#indirectEffects').html((indirectEffects*100/(teacherWord == 0 ? 1 : teacherWord)).toFixed(1) + '%');
						$('#coordinate1').html((coordinate1*100/(studentWord == 0 ? 1 : studentWord)).toFixed(1) + '%');
						$('#coordinate2').html((coordinate2*100/(studentWord == 0 ? 1 : studentWord)).toFixed(1) + '%');
						$('#coordinate3').html((coordinate3*100/(teacherWord == 0 ? 1 : teacherWord)).toFixed(1) + '%');
					} else {
						$('#fldsPart').html(' ');
					}
					
				})(data);
// 			} catch (e) {
// 				$('.flds').html(e);
// 			}
		}
		if (window.AndroidWebView) {
			window.goEdit = window.AndroidWebView.edit;
			window.goMedia = window.AndroidWebView.media;
		} else {
			function setupWebViewJavascriptBridge(callback) {
				if (window.WebViewJavascriptBridge) { return callback(WebViewJavascriptBridge); }
				if (window.WVJBCallbacks) { return window.WVJBCallbacks.push(callback); }
				window.WVJBCallbacks = [callback];
				var WVJBIframe = document.createElement('iframe');
				WVJBIframe.style.display = 'none';
				WVJBIframe.src = 'wvjbscheme://__BRIDGE_LOADED__';
				document.documentElement.appendChild(WVJBIframe);
				setTimeout(function() { document.documentElement.removeChild(WVJBIframe) }, 0)
			}
			
			setupWebViewJavascriptBridge(function(bridge) {
				bridge.registerHandler('render', function(data, responseCallback) {
					render(data);
				});
				
				window.goEdit = function(sectionId, recordId) {
					bridge.callHandler('edit', { 'section':sectionId, 'record': recordId }, function responseCallback(responseData) {
						console.log("JS received response:", responseData)
					});
				};
				
				window.goMedia = function(sectionId, recordId, mediaIndex, type, mediaId) {
					bridge.callHandler('media', { 'section':sectionId, 'record': recordId, 'media': mediaIndex, 'type':type, 'mediaId': mediaId },
					function responseCallback(responseData) {
						console.log("JS received response:", responseData)
					});
				};
			});
		}
	</script>
	<script id="data" type="text/json">
		[
			[1,2,2,2,2,2,3,1,1,1],[2,2,2,2,2,2,2,3,8,9,9,4,6,7,1,2,5,10,10,10,11,11,11,2,1,1,1,1]
		]
	</script>
</body>
</html>